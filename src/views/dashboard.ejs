<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  const socket = io();

  // Join user's room
  socket.emit('joinRoom', <%= user.id %>);

  // Listen for new transactions
  socket.on('newTransaction', async (data) => {
    alert(`New transaction: ${data.type === 'sent' ? 'Sent $'+data.amount : 'Received $'+data.amount}`);

    // Refresh chart
    const res = await fetch('/dashboard/chart-data');
    const chartData = await res.json();
    walletChart.data.labels = chartData.dates;
    walletChart.data.datasets[0].data = chartData.income;
    walletChart.data.datasets[1].data = chartData.expense;
    walletChart.update();

    // Refresh transactions table
    location.reload(); // simple way; can implement dynamic table update later
  });
  </script>

</head>
<body>
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
      <h2>Welcome, <%= user.name %></h2>
      <a href="/auth/transfer" class="btn btn-outline-primary">transfer</a><a href="/auth/logout" class="btn btn-danger">Logout</a>
    </div>

    <div class="row mt-4">
      <div class="col-md-4">
        <div class="card text-center p-3 shadow">
          <h5>Wallet Balance</h5>
          <h2>$<%= balance %></h2>
        </div>
      </div>
      <div class="col-md-8">
        <canvas id="walletChart" height="150"></canvas>
      </div>
    </div>

    <div class="mt-4">
      <h4>Recent Transactions</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Category</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <% transactions.forEach(t => { %>
            <tr>
              <td><%= t.created_at.toISOString().split('T')[0] %></td>
              <td><%= t.type %></td>
              <td>$<%= t.amount %></td>
              <td><%= t.category %></td>
              <td><%= t.description %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function fetchChartData() {
      const res = await fetch('/dashboard/chart-data');
      const data = await res.json();

      const ctx = document.getElementById('walletChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [
            {
              label: 'Income',
              data: data.income,
              borderColor: 'green',
              fill: false
            },
            {
              label: 'Expense',
              data: data.expense,
              borderColor: 'red',
              fill: false
            }
          ]
        },
        options: { responsive: true }
      });
    }

    fetchChartData();
  </script>
</body>
</html>
